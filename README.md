# car_detection
摘要
   目前模式识别、机器学习等新兴领域的发展带动了计算机视觉的前进。在基于视觉的对象识别中，机器学习的方法由于识别性能高，鲁棒性好以及操作便捷而受到越来越多的关注。机器学习方法主要用于进行两类的分类识别：目标物或非目标物。针对基于方向梯度直方图（HOG）的车辆检测方案在智能监控、车辆辅助驾驶系统中具有重要的应用价值，是当前最热门的研究课题之一。本文结合HOG特征提取和SVM分类器对获得的视频中的车辆进行识别验证，利用采集的道路视频进行了车辆识别实验。
ABSTRACT
At present, the development of pattern recognition, machine learning and other emerging fields drives the advance of computer vision. In the object recognition based on vision, the machine learning method attracts more and more attention because of its high recognition performance, good robustness and convenient operation. Machine learning methods are mainly used for the classification and identification of two kinds: target or non-target. The vehicle detection based on Histogram of Oriented Gradient (HOG) has important application value in the intelligent monitoring and vehicle driving system, and it is one of the most popular research topics at present. In this paper, the HOG feature extraction and SVM classifier are used to identify the vehicle in the video, and the vehicle identification experiment is carried out using the collected road video.
keywords：Histogram of Oriented gradient, Support vector machine, Vehicle classifier, Blind obstacle recognition.

1、背景介绍：
     目前多数城市的盲道没有完全的发挥作用，盲道设计不规范，占道现象严重等问题为导盲工作带来了巨大的阻碍，但重建新型电子导盲系统需要大规模更改设计现有盲道，不适合推广且成本较高。而基于计算机视觉的识别方法具有信息丰富、价格低、易于实现识别和跟踪等优势已经被越来越广泛地应用于道路场景的检测和物体识别，这一方法也就成为了解决当前盲道问题的首选方案。
近年来，使用HOG特征实现行人检测系统成为研究热点。这类系统有些在通用图形处理器上实现，一些在FPGA+GPU异构计算平台上实现，但上述系统考虑了性能与设计复杂性的折中，增加了设备成本，但性能并不太理想。在FPGA上实现的方案存在以下问题：（1）采用多路流水线计算方向梯度直方图，需要进行预处理并缓存中间结果，这样会消耗较多的FPGA资源；（2）将HOG特征生成模块与SVM分类器分开设计存在处理效率不高、SVM乘法器位宽大等问题；（3）HOG特征分类器会造成同一车辆被多个窗口同时检测到，存在检测的重复性。本文的目标是采用HOG特征的SVM分类器，利用自己亲自动手制作的数据集进行车辆的识别和跟踪。
2、研究内容及方法
2.1 SVM分类器
2.1.1 SVM概述
在机器学习领域，支持向量机SVM（Support Vector Machine）是一个有监督的学习模型，通常用来进行模式识别、分类以及回归分析。SVM方法是从线性可分情况下的最优分类面而提出的，所谓最优分类面就是要求分类面不但能将两类无错误地分开，而且要使两类的分类间隔最大。前者是保证经验风险最小，如使训练误差为0，而使分类间隔最大实际上就是推广性的界中置信范围最小，从而使真实风险最小。
SVM是建立在统计学习理论基础上的第一个学习算法，根据有限的样本信息在模型的复杂性（对特定训练样本的学习精度）和学习能力（即无错误地识别任意样本的能力）之间寻求最佳折中，以期获得最好的推广能力，是统计学习，最优化方法和核函数方法的结合。目前主要应用于分类和回归问题。SVM以分类和回归的泛化性能为目标，即分布意义下的总体错误率最小，而对非训练样本有较高的预测准确率。
	SVM方法是通过一个非线性映射p，把样本空间映射到一个高维乃至无穷维的特征空间（Hilbert空间）中，使得在原来的样本空间中非线性可分问题转化为在特征空间中的线性可分问题，简单地说就是升维和线性化。升维就是把样本向高维空间做映射，一般情况下会增加计算的复杂性，但是作为分类、回归等问题来说，很可能在低维样本空间无法线性处理的样本集却可以在高维空间中通过一个线性超平面实现线性划分（或回归），SVM方法巧妙地解决了计算复杂性这一难题：应用和函数的展开定理，就不需要知道非线性映射的显示表达式；由于是在高维特征空间中建立线性学习机，所以与线性模型相比，不但几乎不增加计算复杂性，而且在某种程度上避免了“维数灾难”，这一切要归功于核函数的展开和计算理论。
SVM的主要思想可以概括为两点：（1）它是针对线性可分情况进行分析，对于线性不可分的情况，通过使用非线性映射算法将低维输入空间线性不可分的样本转化为高维特征空间使其线性可分，从而使得高维特征空间采用线性算法对样本的非线性特征进行线性分析成为可能。（2）它基于结构风险最小化的理论上在特征空间中建构最优分割超平面，使得学习器得到全局最优化，并且在整个样本空间的期望风险以某个概率满足一定上界。
2.1.2 SVM特征
	SVM一般具有以下特征
（1）SVM学习问题可以表示为凸优化问题，因此可以利用已知的有效算法发现目标函数的全局最小值。而其他分类方法（如基于规则的分类器和人工神经网络）都采用一种基于贪心学习的策略来搜索假设空间，这种方法一般只能获得局部最优解。
（2）SVM通过最大化决策边界的边缘来控制模型的能力。尽管如此，用户必须提供其他参数，如使用核函数类型和引入松弛变量等。通过对数据中每个分类属性引入一个哑变量，SVM可以应用与分类数据。SVM一般只能在二类问题，对于多类问题效果不符。
2.2 HOG特征
2.2.1 HOG特征概述
	HOG（Histogram of Oriented Gradient）是用于目标检测的特征描述子，该技术将图像局部出现的方向梯度次数进行计数，该方法和边缘方向直方图、scale-invariant feature transform类似，不同的是HOG的计算基于一致空间的密度矩阵来提高准确率。Navneet Dalal和Bill Triggs首先在05年的CVPR中提出HOG，用于静态图像或视频的行人检测。
2.2.2 HOG特征原理
	HOG的核心思想是所检测的局部物体外形能够被光强梯度或边缘方向的分布所描述。通过将整幅图像分割成小的连接区域（称为cells），每个cell生成一个方向梯度直方图或者cell中pixel的边缘方向，这些直方图的组合可表示出（所检测目标的目标）描述子。为改善准确率，局部直方图可以通过计算图像中一个较大区域（称为block）的光强作为measure被对比标准化，然后用这个值（measure）归一化这个block中的所有cells.这个归一化过程完成了更好的照射/阴影不变性。与其他描述子相比，HOG得到的描述子保持了几何和光学转化不变性（除非物体方向改变）。因此HOG描述子尤其适合车辆或人的检测。通俗地讲HOG特征提取方法就是将一幅图片：
(1)	灰度化（将图像看作一个xyz（灰度）的三维图像）
(2)	划分成小cells（2x2）
(3)	计算每个cell中每个pixel的gradient（即orientation）
(4)	统计每个cell的梯度直方图（不同梯度的个数），即可形成每个cell的descriptor
2.2.3 HOG特征与与其它特征的区别
	Hog没有旋转和尺度不变性，因此计算量小；而SIFT中每个feature需要用128维的向量来描述，因此计算量相对很大。对于一般的车辆或行人检测如何应用HOG呢？
对于解决Scale-invariant 的问题：将图片进行不同尺度的缩放，就相当于对模板进行不同尺度scale的缩放对于解决Rotation-invariant 的问题：建立不同方向的模版（一般取15*7的）进行匹配总的来说，就是在不同尺度上的图像进行不同方向的模板（15*7）匹配，每个点形成一个8方向的梯度描述。SIFT由于其庞大计算量不用与行人检测，而PCA-SIFT的方法过滤掉很多维度的信息，只保留20个主分量，因此只适用于行为变化不大的物体检测。

2.3 实现过程
2.3.1 样本制作
	在准备训练样本集合的过程中，根据机器学习的基础知识我们知道，要利用机器学习算法进行样本训练，从而得到一个性能优良的分类器，训练样本应该是无限多的，而且训练样本应该覆盖实际过程中可能发生的各种情况。但在实际过程中训练样本不可能无限多，但也不应该过少，要根据实际情况进行正负样本的分配。我的任务是识别视频中的车辆，因此我们的正样本应该都是汽车的图片，而负样本应该都是一些道路场景图，从而确保较高的检测率。网上搜集以及实地采集图片后，我手动裁剪出图片中汽车的部分将之作为正样本数据集。在实验部分，我们总共制作了50个正样本、400个负样本。正负样本的比例需要人为的调整，因为对于不同的场景，检测出的准确的差异会很大。我们通过采集学校周围的视频进行检验发现，该比例可以满足实际场景的要求。

2.3.2 代码实现过程
	大致思路是：首先计算正负样本图像的HOG描述子，组成一个特征向量矩阵，对应的要有一个指定每个特征向量的类别的类标向量，输入SVM中进行训练。训练好的SVM分类器保存为XML文件，然后根据其中的支持向量和参数生成OpenCV中的HOG描述子可用的检测子参数，再调用OpenCV中的多尺度检测函数进行车辆检测。
2.3.2.1 正负样本训练
	首先建立MySVM类，该类集成自OpenCV中的CvSVM，目的是能够获得SVM决策函数中的alpha数组和rho参量（因为这两个参数在父类中是protected类型，无法直接访问）。而后建立HOG检测器用来计算HOG描述子，其中参数采用默认值，即检测窗口（64,128），块尺寸（16,16），块步长（8,8），cell尺寸（8,8），直方图bin个数9。然后提取所有正负样本的HOG特征并赋予样本标签（正样本类别为1，负样本类别为-1）。这里我们为了提高检测准确度，添加了Hard Example（难例）。

	难例（或叫做难样本，Hard Example，Hard Negative，Hard Instance）是指利用第一次训练的分类器在负样本原图(肯定没有车辆)上进行车辆检测时所有检测到的矩形框，这些矩形框区域很明显都是误报，把这些误报的矩形框保存为图片，加入到初始的负样本集合中，重新进行SVM的训练，可显著减少误报。这种方法叫做自举法(Bootstrap)，自举法首先使用初始负样本集来训练一个模型，然后收集被这个初始模型错误分类的负样本来形成一个负样本难例集。用此负样本难例集训练新的模型，此过程可以重复多次。比如典型的误报如下：
	上图中将树干误认为是车辆，这些就是Hard Example，将这些矩形框保存为64*128的图片文件，加入到负样本集合中。也就是说，难例就是分错类的负样本，将难例加入负样本集合能够进行二次训练。
	最后进行分类器训练，将训练好的SVM模型保存为xml文件。
2.3.2.2  车辆检测
	我们读取一段视频，检测并跟踪视频中的汽车，用绿色矩形框在视频每帧中标注出它们。由于会出现矩形框嵌套的情况，我们选取最大的矩形框作为检测结果。
